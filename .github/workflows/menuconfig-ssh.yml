name: make menuconfig

# é˜²æ­¢å¤šä¸ªæ„å»ºåŒæ—¶è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
  REPO_BRANCH: openwrt-24.10-6.6
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: config/128m.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  menuconfig:
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ™Œ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: ğŸš¥ Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libncurses-dev build-essential git wget python3 bzip2
          sudo apt-get clean

          echo "ğŸ“ Creating workdir"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: ğŸªœ Clone source code
        working-directory: /workdir
        run: |
          echo "ğŸ“¥ Cloning $REPO_URL (branch: $REPO_BRANCH)"
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --filter=blob:none openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "âœ… Source code cloned successfully"

      - name: ğŸ‘©â€ğŸ’» Copy previous config if exists
        run: |
          if [ -f "$GITHUB_WORKSPACE/${CONFIG_FILE}" ]; then
            echo "ğŸ“ Copying previous config to openwrt/.config"
            cp -f "$GITHUB_WORKSPACE/${CONFIG_FILE}" /workdir/openwrt/.config
          else
            echo "âš ï¸ No previous config found at $GITHUB_WORKSPACE/${CONFIG_FILE}"
          fi

      - name: âš™ï¸ Load custom feeds
        run: |
          set -e
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: ğŸ§¬ Update feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: ğŸª› Install feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: ğŸ§© Load custom configuration
        run: |
          set -e
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH

      - name: âŒ¨ï¸ Start tmate session
        uses: mxschmitt/action-tmate@v3

      - name: ğŸ“¤ Push config to main branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CONFIG_FILE: ${{ env.CONFIG_FILE }}
        run: |
          set -e

          SRC="/workdir/openwrt/.config"
          DST="$GITHUB_WORKSPACE/${CONFIG_FILE}"

          echo "Source: $SRC"
          echo "Target: $DST"

          if [ ! -f "$SRC" ]; then
            echo "No .config found at $SRC. Nothing to do."
            exit 0
          fi

          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨å¹¶æ‹·è´  
          mkdir -p "$(dirname "$DST")"   
          cp -f "$SRC" "$DST"   
          echo "Copied .config to $DST"   
 
          cd "$GITHUB_WORKSPACE"   
   
          git config user.name "github-actions[bot]"   
          git config user.email "github-actions[bot]@users.noreply.github.com"   
 
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´  
          git add "$CONFIG_FILE"   
          if git diff --cached --quiet; then  
            echo "No changes to commit."   
            exit 0  
          fi  
 
          # ç›´æ¥æ¨é€åˆ°ä¸»åˆ†æ”¯  
          git commit -m "Update OpenWrt config: ${CONFIG_FILE}"   
          git push origin HEAD:main
